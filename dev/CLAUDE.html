<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>CLAUDE.md • cnefetools</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"><link rel="icon" sizes="any" href="favicon.ico"><link rel="manifest" href="site.webmanifest"><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="CLAUDE.md"><meta property="og:image" content="https://pedreirajr.github.io/cnefetools/logo.svg"><meta name="robots" content="noindex"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">cnefetools</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.2.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/read_cnefe.html">Reading and exploring CNEFE data</a></li>
    <li><a class="dropdown-item" href="articles/cnefe_counts.html">Aggregating CNEFE address counts</a></li>
    <li><a class="dropdown-item" href="articles/compute_lumi.html">Computing land-use mix indices with CNEFE data</a></li>
    <li><a class="dropdown-item" href="articles/tracts_to.html">Dasymetric interpolation using CNEFE addresses</a></li>
    <li><a class="dropdown-item" href="articles/faq.html">FAQ</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pedreirajr/cnefetools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="logo.svg" class="logo" alt=""><h1>CLAUDE.md</h1>
      <small class="dont-index">Source: <a href="https://github.com/pedreirajr/cnefetools/blob/dev/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="claudemd" class="section level1">

<p>This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.</p>
<div class="section level2">
<h2 id="package-overview">Package Overview<a class="anchor" aria-label="anchor" href="#package-overview"></a></h2>
<p><strong>cnefetools</strong> is an R package for working with 2022 Brazilian CNEFE (National Address File for Statistical Purposes) data from IBGE. It provides tools for downloading, reading, and analyzing address-level data with spatial aggregation capabilities.</p>
</div>
<div class="section level2">
<h2 id="common-commands">Common Commands<a class="anchor" aria-label="anchor" href="#common-commands"></a></h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># Development workflow</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">load_all</span>()         <span class="co"># Load package for interactive development</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">document</span>()         <span class="co"># Regenerate documentation from roxygen2 comments</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">test</span>()             <span class="co"># Run all tests</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">check</span>()            <span class="co"># Full R CMD check</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="co"># Run a single test file</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>testthat<span class="sc">::</span><span class="fu">test_file</span>(<span class="st">"tests/testthat/test-read_cnefe.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co"># Build package</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>R CMD BUILD . <span class="sc">--</span>no<span class="sc">-</span>manual <span class="sc">--</span>compact<span class="sc">-</span>vignettes<span class="ot">=</span>gs<span class="sc">+</span>qpdf</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<div class="section level3">
<h3 id="core-functions-r">Core Functions (R/)<a class="anchor" aria-label="anchor" href="#core-functions-r"></a></h3>
<ul><li>
<strong>read_cnefe.R</strong> - Downloads and reads CNEFE CSV files for a municipality; returns Arrow tables or sf spatial objects</li>
<li>
<strong>cnefe_counts.R</strong> - Aggregates address counts to H3 hexagonal grid cells or user-provided polygons (DuckDB or pure-R backend)</li>
<li>
<strong>compute_lumi.R</strong> - Computes land-use mix indices (Entropy Index, HHI, BGBI, Balance Index)</li>
<li>
<strong>tracts_to_h3.R</strong> - Dasymetric interpolation from census tracts to H3 via CNEFE dwelling points</li>
<li>
<strong>build_h3_grid.R</strong> - Internal utility to create H3 grids from IDs or municipality boundary</li>
<li>
<strong>utils-internal.R</strong> - Input validation, cache management, download helpers, DuckDB extension utilities</li>
</ul></div>
<div class="section level3">
<h3 id="key-design-patterns">Key Design Patterns<a class="anchor" aria-label="anchor" href="#key-design-patterns"></a></h3>
<ul><li>
<strong>Dual backends</strong>: Functions support both DuckDB (SQL-based, fast) and pure-R backends via <code>use_duckdb</code> parameter</li>
<li>
<strong>Caching</strong>: ZIP files are cached in user directory (<code>tools::R_user_dir("cnefetools", "cache")</code>) for automatic reuse</li>
<li>
<strong>DuckDB extensions</strong>: Uses h3 and zipfs extensions loaded via helper functions in utils-internal.R</li>
</ul></div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>
<p>Tests use fixture-based mocking to avoid network dependencies: - <code>helper-fixture.R</code> provides <code>mock_ensure_zip_fixture()</code> for mocked downloads - Offline fixture at <code>inst/extdata/cnefe_fixture_cnefe.zip</code> - Use <code><a href="https://testthat.r-lib.org/reference/local_mocked_bindings.html" class="external-link">testthat::with_mocked_bindings()</a></code> pattern for network isolation</p>
</div>
<div class="section level3">
<h3 id="key-dependencies">Key Dependencies<a class="anchor" aria-label="anchor" href="#key-dependencies"></a></h3>
<ul><li>
<strong>Spatial</strong>: sf, geobr, h3jsr, duckspatial</li>
<li>
<strong>Data</strong>: arrow, dplyr, tidyr, DBI, duckdb</li>
<li>
<strong>Utilities</strong>: cli (messages), checkmate (validation), httr2 (downloads)</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="github-workflow">GitHub Workflow<a class="anchor" aria-label="anchor" href="#github-workflow"></a></h2>
<p>Always use GitHub CLI (<code>gh</code>) to manage issues, branches, and PRs:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># List open issues</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">gh</span> issue list</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># View issue details</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="ex">gh</span> issue view <span class="op">&lt;</span>number<span class="op">&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Create branch from an issue (format: &lt;number&gt;-&lt;slug&gt;)</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="ex">gh</span> issue develop <span class="op">&lt;</span>number<span class="op">&gt;</span> --checkout</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># Create PR linked to the issue</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="ex">gh</span> pr create <span class="at">--fill</span></span></code></pre></div>
<p>When working on an issue: 1. Review the issue with <code>gh issue view</code> 2. Create branch with <code>gh issue develop &lt;number&gt; --checkout</code> 3. Implement the changes 4. Create PR with <code>gh pr create</code> referencing the issue (e.g., “Closes #<number>”)</number></p>
</div>
<div class="section level2">
<h2 id="code-conventions">Code Conventions<a class="anchor" aria-label="anchor" href="#code-conventions"></a></h2>
<ul><li>
<strong>All comments in code must be written in English</strong> (including TODO comments, inline comments, and roxygen2 documentation)</li>
<li>All documentation uses roxygen2 inline comments (regenerate with <code>devtools::document()</code>)</li>
<li>Municipality codes must be 7-digit IBGE codes (validated by <code>.normalize_code_muni()</code>)</li>
<li>Internal functions prefixed with <code>.</code> (e.g., <code>.cnefe_cache_dir()</code>, <code>.normalize_code_muni()</code>)</li>
</ul></div>
<div class="section level2">
<h2 id="rendering-github-pages-articles">Rendering GitHub Pages Articles<a class="anchor" aria-label="anchor" href="#rendering-github-pages-articles"></a></h2>
<p>Articles live in <code>vignettes/articles/</code> and use a <strong>pre-rendered workflow</strong> to work around mapview/leaflet HTML widgets that cannot be rendered by pkgdown alone. The flow is:</p>
<ol style="list-style-type: decimal"><li>
<strong>Source files are <code>.Rmd.orig</code></strong> — these are the editable sources. Always edit the <code>.orig</code> files, never the <code>.Rmd</code> directly.</li>
<li>
<strong>Render <code>.orig</code> → <code>.Rmd</code></strong> using <code>_build.R</code>. This executes all R code, embeds mapview widget HTML as interactive <code>&lt;!--html_preserve--&gt;</code> blocks and generates static PNG figures for ggplots.</li>
<li>
<strong>pkgdown</strong> then builds the final HTML site from the pre-rendered <code>.Rmd</code> files (which already contain all output).</li>
</ol><div class="section level3">
<h3 id="how-to-render--always-use-_buildr">How to render — ALWAYS use <code>_build.R</code>
<a class="anchor" aria-label="anchor" href="#how-to-render--always-use-_buildr"></a></h3>
<p><strong>CRITICAL</strong>: Always render articles by running <code>_build.R</code> from the package root:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"vignettes/articles/_build.R"</span><span class="op">)</span></span></code></pre></div>
<p><strong>NEVER</strong> call <code><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knitr::knit()</a></code> directly on <code>.Rmd.orig</code> files. The <code>_build.R</code> script does three essential things that a bare <code><a href="https://rdrr.io/pkg/knitr/man/knit.html" class="external-link">knitr::knit()</a></code> call does not:</p>
<ol style="list-style-type: decimal"><li>
<strong>Sets <code>knitr::opts_knit$set(rmarkdown.pandoc.to = "html")</code></strong> — Without this, knitr does not know the output target is HTML and will render <code>mapview()</code> widgets as static PNG screenshots (via webshot/phantomjs) instead of embedding interactive HTML. The <code><a href="https://rdrr.io/pkg/leafsync/man/latticeView.html" class="external-link">leafsync::sync()</a></code> function is not affected by this because it uses a different print method, but standalone <code>mapview()</code> calls will silently produce PNGs. This is the most common rendering pitfall.</li>
<li>
<strong>Sets the working directory to <code>vignettes/articles/</code></strong> — So <code>fig.path</code> resolves correctly and figures land in the right place.</li>
<li>
<strong>Injects a hidden dependency chunk into each <code>.Rmd</code></strong> — pkgdown needs to discover mapview/leaflet JS/CSS dependencies. Since the pre-rendered <code>.Rmd</code> contains raw HTML (not R chunks that produce widgets), <code>_build.R</code> injects a hidden <code>include=FALSE</code> chunk after the YAML header that loads mapview/leafsync and calls <code><a href="https://r-spatial.github.io/mapview/reference/mapView.html" class="external-link">mapview::mapview()</a></code>. This forces pkgdown to include the required JS/CSS. Without it, interactive maps appear blank.</li>
</ol></div>
<div class="section level3">
<h3 id="key-rendering-rules-for-rmdorig-files">Key rendering rules for <code>.Rmd.orig</code> files<a class="anchor" aria-label="anchor" href="#key-rendering-rules-for-rmdorig-files"></a></h3>
<div class="section level4">
<h4 id="figdpi-must-not-be-set-globally">
<code>fig.dpi</code> must NOT be set globally<a class="anchor" aria-label="anchor" href="#figdpi-must-not-be-set-globally"></a></h4>
<p>The <code>opts_chunk$set()</code> in each <code>.Rmd.orig</code> setup chunk must <strong>not</strong> include <code>fig.dpi</code>. knitr uses <code>fig.width * dpi</code> to compute the inline <code>style="width:..."</code> attribute of htmlwidgets. With the default dpi (72), a widget gets <code>width:504px</code>. Setting <code>fig.dpi = 600</code> globally inflates widgets to <code>width:4200px</code>, making maps unusable.</p>
<p><strong>If a ggplot chunk needs high resolution</strong>, set <code>fig.dpi = 600</code> on that specific chunk only:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="st">```</span><span class="at">{r, fig.width = 8, fig.height = 4, fig.dpi = 600}</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="at">ggplot(...) + ...</span></span></code></pre></div>
<p>```</p>
<p>Currently, only two chunks use this: one in <code>compute_lumi.Rmd.orig</code> and one in <code>tracts_to.Rmd.orig</code>.</p>
</div>
<div class="section level4">
<h4 id="outwidth--100-is-set-globally">
<code>out.width = "100%"</code> is set globally<a class="anchor" aria-label="anchor" href="#outwidth--100-is-set-globally"></a></h4>
<p>All articles set <code>out.width = "100%"</code> in <code>opts_chunk$set()</code> so that both mapview widgets and ggplot images adapt to the page width instead of having a fixed pixel size.</p>
</div>
<div class="section level4">
<h4 id="do-not-add-cat-based-dependency-injection-to-rmdorig">Do NOT add <code>cat()</code>-based dependency injection to <code>.Rmd.orig</code>
<a class="anchor" aria-label="anchor" href="#do-not-add-cat-based-dependency-injection-to-rmdorig"></a></h4>
<p>The dependency chunk injection is handled exclusively by <code>_build.R</code> post-processing. Do <strong>not</strong> add <code>cat('```{r include=FALSE}\n')</code> tricks to <code>.Rmd.orig</code> files — this creates duplicate dependency chunks and is unnecessary.</p>
</div>
</div>
<div class="section level3">
<h3 id="diagnosing-rendering-problems">Diagnosing rendering problems<a class="anchor" aria-label="anchor" href="#diagnosing-rendering-problems"></a></h3>
<p>If mapview widgets render as static images (PNGs) instead of interactive maps: - <strong>Cause</strong>: Articles were rendered without <code>rmarkdown.pandoc.to = "html"</code>. - <strong>Fix</strong>: Re-render using <code>source("vignettes/articles/_build.R")</code>. - <strong>How to verify</strong>: Check the <code>.Rmd</code> for <code>&lt;!--html_preserve--&gt;</code> markers. Interactive widgets produce these; PNG fallbacks produce <code>![plot of chunk ...]()</code> image references instead.</p>
<p>If mapview widgets are extremely large (need to zoom out to see them): - <strong>Cause</strong>: <code>fig.dpi</code> is set too high in the global <code>opts_chunk$set()</code>. - <strong>Fix</strong>: Remove <code>fig.dpi</code> from the global setup; only set it per-chunk on ggplot chunks. - <strong>How to verify</strong>: Check the <code>.Rmd</code> for <code>style="width:...px"</code> on leaflet divs. Should be <code>width:100%</code>, not <code>width:4200px</code>.</p>
<p>If interactive maps appear as blank white boxes on the deployed site: - <strong>Cause</strong>: The dependency injection chunk is missing from the <code>.Rmd</code>. - <strong>Fix</strong>: Re-render using <code>_build.R</code>, which injects it automatically. - <strong>How to verify</strong>: Check the <code>.Rmd</code> for a <code>```{r include=FALSE}</code> chunk containing <code><a href="https://r-spatial.github.io/mapview/reference/mapView.html" class="external-link">mapview::mapview()</a></code> near the top of the file.</p>
</div>
<div class="section level3">
<h3 id="what-gets-committed">What gets committed<a class="anchor" aria-label="anchor" href="#what-gets-committed"></a></h3>
<p>Both <code>.Rmd.orig</code> (source) and <code>.Rmd</code> (pre-rendered output) are committed to the repo, along with the <code>*_files/figure-html/</code> directories containing generated PNGs for ggplot figures.</p>
</div>
</div>
<div class="section level2">
<h2 id="ai-assistant-guidelines">AI Assistant Guidelines<a class="anchor" aria-label="anchor" href="#ai-assistant-guidelines"></a></h2>
<ul><li>
<strong>Always read all relevant <code>.R</code> files</strong> in <code>R/</code> and <code>tests/testthat/</code> directories before making changes</li>
<li>Understand the existing code structure and patterns before proposing modifications</li>
<li>Ensure consistency with the package’s coding style and conventions</li>
<li>
<strong>Do NOT add <code>Co-Authored-By</code> lines for Claude in commits or PRs</strong> (no AI co-authorship attribution)</li>
</ul><div class="section level3">
<h3 id="model-usage-optimization">Model Usage Optimization<a class="anchor" aria-label="anchor" href="#model-usage-optimization"></a></h3>
<p>To optimize token usage, prefer different models for different task types:</p>
<ul><li>
<strong>Opus 4.5</strong> (higher token cost): Use for planning, architectural decisions, complex investigation, and design work</li>
<li>
<strong>Sonnet 4</strong> (lower token cost): Use for execution of well-defined tasks, repetitive edits, and straightforward implementations</li>
</ul><p>When starting a complex task, first use Opus for planning and analysis, then switch to Sonnet for the execution phase.</p>
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jorge Ubirajara Pedreira Junior, Bruno Mioto.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

