---
output:
  github_document:
    html_preview: false
---

# cnefetools: Tools for working with Brazilian CNEFE 2022 Address Data <img src="man/figures/logo.png" alt="logo" align="right" width="190"/>

[![R-CMD-check](https://github.com/pedreirajr/cnefetools/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/pedreirajr/cnefetools/actions/workflows/R-CMD-check.yaml) [![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE.md)

**{cnefetools}** provides helper functions to work with the 2022 Brazilian National Address File for Statistical Purposes (*Cadastro Nacional de Endereços para Fins Estatísticos*, CNEFE), an address-level dataset released by the Brazilian Institute of Geography and Statistics (*Instituto Brasileiro de Geografia e Estatística*, IBGE).

## Installation

``` r
# install.packages("pak")
pak::pak("pedreirajr/cnefetools")
```

## Basic usage

``` r
library(cnefetools)

# Example: read CNEFE data for a municipality (Salvador) as an Arrow table
tab_ssa <- read_cnefe(2927408, cache = TRUE)

# Convert to a data frame for inspection
df_ssa <- tab_ssa %>%
  as.data.frame()

head(df_ssa)
```

## Spatial output and quick map

If you prefer to work with spatial objects, `read_cnefe()` can return an `sf` object by setting `output = "sf"`.\
The example below reads CNEFE data for Salvador, filters only religious facilities (`COD_ESPECIE == 8`), and plots them with `ggplot2`:

``` r
library(cnefetools)
library(sf)
library(ggplot2)
library(dplyr)

# Read CNEFE data as sf (Salvador, IBGE code = 2927408)
tab_ssa_sf <- read_cnefe(code_muni = 2927408, output = "sf", cache = TRUE)

# Keep only religious facilities (COD_ESPECIE == 8)
templos_ssa <- tab_ssa_sf %>%
  dplyr::filter(COD_ESPECIE == 8)

ggplot() +
  geom_sf(data = templos_ssa, size = 0.3, alpha = 0.6) +
  coord_sf() +
  theme_minimal()
```

> **Warning**\
> For large municipalities, CNEFE may contain more than 1 million address points.\
> Plotting all coordinates at once can be slow and memory intensive, so consider filtering by area of interest or sampling points before creating maps.

## Caching behavior

By default, `cache = TRUE` stores the downloaded ZIP file in a user-level cache directory specific to this package.\
The exact location is handled internally via:

``` r
tools::R_user_dir("cnefetools", "cache")
```

If you prefer to avoid persistent caching, set:

``` r
tab_ssa <- read_cnefe(code_muni = 2927408, cache = FALSE)
```

In this case, the ZIP file is stored in a temporary location and removed after reading.

## Accessing official CNEFE documentation

**cnefetools** includes local copies of the official methodological note and the variable dictionary for the 2022 CNEFE released by IBGE.

You can open these documents in your default PDF and spreadsheet viewers with:

``` r
# Open the official methodological note (PDF)
cnefe_doc()

# Open the official variable dictionary (Excel)
cnefe_dictionary()
```

## Land use mix indicators with `compute_lumi()`

The function `compute_lumi()` computes mixed land use indicators on an H3 hexagonal grid for any Brazilian municipality covered by the 2022 CNEFE (Pedreira Junior et al, 2025). Internally, it: (i) Reads and preprocesses address points from CNEFE; (ii) Builds an H3 grid over the municipal boundary; (iii) Aggregates residential and non-residential addresses per hexagon; and (iv) Computes the following indicators:

-   `p_res`: proportion of residential addresses in each hexagon.
-   `ei`: Entropy Index (EI), ranging from 0 (single use) to 1 (balanced residential/non-residential).
-   `hhi`: Herfindahl–Hirschman Index (HHI) for two uses (residential vs. non-residential), ranging from 0.5 (balanced residential/non-residential) to 1 (single use).
-   `hhi_adp`: adapted HHI, which adds directionality and takes values in [−1, 1], where negative values indicate non-residential dominance and positive values indicate residential dominance.
-   `bgbi`: Bidirectional Global-centered Balance Index (BGBI), which measures the deviation of the local residential share from the citywide residential proportion, also in [−1, 1].

Below is an example for Fortaleza (IBGE code 2304400) at H3 resolution 8:

``` r
library(cnefetools)
library(sf)
library(ggplot2)
library(dplyr)

# Compute land use mix indicators on an H3 grid
lumi_for <- compute_lumi(code_muni = 2304400, h3_resolution = 8, verbose = TRUE)

# Quick summary of the resulting sf object
lumi_for
```

You can also visualize the spatial distribution of the BGBI indicator with `ggplot2`:

``` r
ggplot(lumi_for) +
  geom_sf(aes(fill = bgbi), color = NA) +
  scale_fill_viridis_c(option = "plasma") +
  coord_sf() +
  labs(fill = "BGBI",
       title = "Bidirectional Global-centered Balance Index (BGBI)",
       subtitle = "Hexagonal grid (H3) for Fortaleza - CNEFE 2022") +
  theme_minimal()
```

## Citation

If you use **cnefetools** in scientific work, please cite the associated preprint:

> Pedreira Jr., J. U.; Louro, T.V.; Assis, L. B. M.; Brito, P. L. *Measuring land use mix with address-level census data* (2025). engrXiv. <https://engrxiv.org/preprint/view/5975>

## Roadmap

The current version focuses on efficiently downloading, caching, and reading municipality-level CNEFE CSV files into Arrow tables or `sf` objects and on computing mixed land use indicators over H3 grids. Planned extensions include:

-   Functions to support dasymetric population interpolation using CNEFE as ancillary data.
-   Performance improvements and alternative backends for spatial joins in `compute_lumi()`, including high-performance frameworks for spatial big data processing, such as SedonaDB and DuckDB’s spatial extensions.
