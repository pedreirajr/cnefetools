<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Tools for Working with Brazilian CNEFE 2022 Address Data • cnefetools</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Tools for Working with Brazilian CNEFE 2022 Address Data">
<meta name="description" content="Provides helper functions to work with the Cadastro Nacional de Endereços para Fins Estatísticos (CNEFE) from the 2022 Brazilian census. The initial version focuses on efficiently downloading, caching, and reading municipality-level CNEFE CSV files into Arrow tables for downstream analysis.">
<meta property="og:description" content="Provides helper functions to work with the Cadastro Nacional de Endereços para Fins Estatísticos (CNEFE) from the 2022 Brazilian census. The initial version focuses on efficiently downloading, caching, and reading municipality-level CNEFE CSV files into Arrow tables for downstream analysis.">
<meta property="og:image" content="https://pedreirajr.github.io/cnefetools/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">cnefetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pedreirajr/cnefetools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header">
<img src="logo.png" class="logo" alt=""><h1 id="cnefetools-tools-for-working-with-brazilian-cnefe-address-data-">cnefetools: Tools for working with Brazilian CNEFE address data <a class="anchor" aria-label="anchor" href="#cnefetools-tools-for-working-with-brazilian-cnefe-address-data-"></a>
</h1>
</div>
<p><a href="https://github.com/pedreirajr/cnefetools/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/pedreirajr/cnefetools/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a> <a href="LICENSE.html"><img src="https://img.shields.io/badge/License-MIT-yellow.svg" alt="License: MIT"></a> <a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></p>
<p><strong>{cnefetools}</strong> provides helper functions to work with the 2022 Brazilian National Address File for Statistical Purposes (<em>Cadastro Nacional de Endereços para Fins Estatísticos</em>, CNEFE), an address-level dataset released by the Brazilian Institute of Geography and Statistics (<em>Instituto Brasileiro de Geografia e Estatística</em>, IBGE).</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("pak")</span></span>
<span><span class="fu">pak</span><span class="fu">::</span><span class="fu"><a href="https://pak.r-lib.org/reference/pak.html" class="external-link">pak</a></span><span class="op">(</span><span class="st">"pedreirajr/cnefetools"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pedreirajr/cnefetools" class="external-link">cnefetools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example: read CNEFE data for a municipality (Salvador) as an Arrow table</span></span>
<span><span class="va">tab_ssa</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_cnefe.html">read_cnefe</a></span><span class="op">(</span><span class="fl">2927408</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to a data frame for inspection</span></span>
<span><span class="va">df_ssa</span> <span class="op">&lt;-</span> <span class="va">tab_ssa</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">df_ssa</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 34</span></span>
<span><span class="co">#&gt;   COD_UNICO_ENDERECO COD_UF COD_MUNICIPIO COD_DISTRITO COD_SUBDISTRITO COD_SETOR</span></span>
<span><span class="co">#&gt;                &lt;int&gt;  &lt;int&gt;         &lt;int&gt;        &lt;int&gt;         &lt;int64&gt; &lt;chr&gt;    </span></span>
<span><span class="co">#&gt; 1          222386741     29       2927408    292740805     29274080518 29274080…</span></span>
<span><span class="co">#&gt; 2           27995350     29       2927408    292740805     29274080522 29274080…</span></span>
<span><span class="co">#&gt; 3           28034841     29       2927408    292740805     29274080522 29274080…</span></span>
<span><span class="co">#&gt; 4          217544957     29       2927408    292740805     29274080518 29274080…</span></span>
<span><span class="co">#&gt; 5          217639781     29       2927408    292740805     29274080526 29274080…</span></span>
<span><span class="co">#&gt; 6          217639701     29       2927408    292740805     29274080526 29274080…</span></span>
<span><span class="co">#&gt; # ℹ 28 more variables: NUM_QUADRA &lt;int&gt;, NUM_FACE &lt;int&gt;, CEP &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   DSC_LOCALIDADE &lt;chr&gt;, NOM_TIPO_SEGLOGR &lt;chr&gt;, NOM_TITULO_SEGLOGR &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   NOM_SEGLOGR &lt;chr&gt;, NUM_ENDERECO &lt;int&gt;, DSC_MODIFICADOR &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   NOM_COMP_ELEM1 &lt;chr&gt;, VAL_COMP_ELEM1 &lt;chr&gt;, NOM_COMP_ELEM2 &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   VAL_COMP_ELEM2 &lt;chr&gt;, NOM_COMP_ELEM3 &lt;chr&gt;, VAL_COMP_ELEM3 &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   NOM_COMP_ELEM4 &lt;chr&gt;, VAL_COMP_ELEM4 &lt;chr&gt;, NOM_COMP_ELEM5 &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   VAL_COMP_ELEM5 &lt;chr&gt;, LATITUDE &lt;dbl&gt;, LONGITUDE &lt;dbl&gt;, …</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="spatial-output-and-quick-map">Spatial output and quick map<a class="anchor" aria-label="anchor" href="#spatial-output-and-quick-map"></a>
</h2>
<p>If you prefer to work with spatial objects, <code><a href="reference/read_cnefe.html">read_cnefe()</a></code> can return an <code>sf</code> object by setting <code>output = "sf"</code>. The example below reads CNEFE data for Salvador, filters only religious facilities (<code>COD_ESPECIE == 8</code>), and plots them with <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pedreirajr/cnefetools" class="external-link">cnefetools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read CNEFE data as sf (Salvador, IBGE code = 2927408)</span></span>
<span><span class="va">tab_ssa_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_cnefe.html">read_cnefe</a></span><span class="op">(</span>code_muni <span class="op">=</span> <span class="fl">2927408</span>, output <span class="op">=</span> <span class="st">"sf"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Keep only religious facilities (COD_ESPECIE == 8)</span></span>
<span><span class="va">temples_ssa</span> <span class="op">&lt;-</span> <span class="va">tab_ssa_sf</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">COD_ESPECIE</span> <span class="op">==</span> <span class="fl">8</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">temples_ssa</span>, size <span class="op">=</span> <span class="fl">0.3</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-4-1.png" width="100%"></p>
<p><strong>Warning</strong></p>
<p>For large municipalities, CNEFE may contain more than 1 million address points. Plotting all coordinates at once can be slow and memory intensive, so consider filtering by area of interest or sampling points before creating maps.</p>
</div>
<div class="section level2">
<h2 id="caching-behavior">Caching behavior<a class="anchor" aria-label="anchor" href="#caching-behavior"></a>
</h2>
<p>By default, <code>cache = TRUE</code> stores the downloaded ZIP file in a user-level cache directory specific to this package. If you prefer to avoid persistent caching, set:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tab_ssa</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/read_cnefe.html">read_cnefe</a></span><span class="op">(</span>code_muni <span class="op">=</span> <span class="fl">2927408</span>, cache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>In this case, the ZIP file is stored in a temporary location and removed after reading.</p>
</div>
<div class="section level2">
<h2 id="accessing-official-cnefe-documentation">Accessing official CNEFE documentation<a class="anchor" aria-label="anchor" href="#accessing-official-cnefe-documentation"></a>
</h2>
<p><strong>{cnefetools}</strong> includes local copies of the official methodological note and the variable dictionary for the 2022 CNEFE released by IBGE.</p>
<p>You can open these documents in your default PDF and spreadsheet viewers with:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Open the official methodological note (PDF)</span></span>
<span><span class="fu"><a href="reference/cnefe_doc.html">cnefe_doc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Open the official variable dictionary (Excel)</span></span>
<span><span class="fu"><a href="reference/cnefe_dictionary.html">cnefe_dictionary</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="hexagon-level-address-counts-with-hex_cnefe_counts">Hexagon-level address counts with <code>hex_cnefe_counts()</code>
<a class="anchor" aria-label="anchor" href="#hexagon-level-address-counts-with-hex_cnefe_counts"></a>
</h2>
<p>The <code><a href="reference/hex_cnefe_counts.html">hex_cnefe_counts()</a></code> function aggregates CNEFE address points into an H3 hexagonal grid of any resolution and returns an <code>sf</code> object with one row per hexagon. It includes:</p>
<ul>
<li>
<code>id_hex</code>: H3 cell identifier.</li>
<li>
<code>addr_type1</code> … <code>addr_type8</code>: counts by address category (see <code><a href="reference/hex_cnefe_counts.html">?hex_cnefe_counts</a></code> for the mapping).</li>
<li>
<code>geometry</code>: hexagon geometry (CRS 4326).</li>
</ul>
<div class="section level3">
<h3 id="choosing-a-backend-performance">Choosing a backend (performance)<a class="anchor" aria-label="anchor" href="#choosing-a-backend-performance"></a>
</h3>
<p><code><a href="reference/hex_cnefe_counts.html">hex_cnefe_counts()</a></code> supports two backends via the <code>backend</code> argument:</p>
<ul>
<li>
<code>backend = "duckdb"</code> (default): uses DuckDB with the community <code>h3</code> extension to compute the H3 cell id and aggregate counts in SQL. This is substantially faster for large municipalities because it avoids materializing all points as an <code>sf</code> object in R.</li>
<li>
<code>backend = "r"</code>: uses <code>sf</code> + <code>h3jsr</code> in R. This is useful when you prefer a pure-R workflow, but it can be much slower for very large cities.</li>
</ul>
<p>To use <code>backend = "duckdb"</code>, you need <code>duckdb</code> installed. On first use, DuckDB may download or install the <code>h3</code> and <code>zipfs</code> extensions (DuckDB community extensions). Subsequent runs reuse the installed extensions.</p>
<p>Below is an example for São Paulo (IBGE code 3550308) at H3 resolution 9:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pedreirajr/cnefetools" class="external-link">cnefetools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fast path (default): DuckDB backend</span></span>
<span><span class="va">hex_sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/hex_cnefe_counts.html">hex_cnefe_counts</a></span><span class="op">(</span>code_muni <span class="op">=</span> <span class="fl">3550308</span>, h3_resolution <span class="op">=</span> <span class="fl">9</span>, backend <span class="op">=</span> <span class="st">"duckdb"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Pure-R path (can be slower for large cities)</span></span>
<span><span class="co"># hex_sp_r &lt;- hex_cnefe_counts(code_muni = 3550308, h3_resolution = 9, backend = "r", verbose = TRUE)</span></span></code></pre></div>
<p>You can visualize the spatial distribution of private households (<code>addr_type1</code>) with <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">hex_sp</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">addr_type1</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"magma"</span>, trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    fill <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Private households (addr_type1)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"São Paulo (IBGE 3550308), H3 resolution 9"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-8-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="land-use-mix-indicators-with-compute_lumi">Land-use mix indicators with <code>compute_lumi()</code>
<a class="anchor" aria-label="anchor" href="#land-use-mix-indicators-with-compute_lumi"></a>
</h2>
<p>The <code><a href="reference/compute_lumi.html">compute_lumi()</a></code> function computes land-use mix indicators on an H3 hexagonal grid at any user-defined resolution for any Brazilian municipality covered by the 2022 CNEFE dataset (<a href="https://engrxiv.org/preprint/view/5975/version/7846" class="external-link">Pedreira Junior et al., 2025</a>). Internally, it: (i) reads and preprocesses address points from CNEFE; (ii) assigns each point to an H3 cell; (iii) aggregates residential and non-residential addresses per hexagon; and (iv) computes the following indicators:</p>
<ul>
<li>
<code>p_res</code>: proportion of residential addresses in each hexagon.</li>
<li>
<code>ei</code>: Entropy Index (EI), ranging from 0 (single use) to 1 (maximum mix), with the maximum attained at <code>p_res</code> = 0.5.</li>
<li>
<code>hhi</code>: Herfindahl–Hirschman Index (HHI), ranging from 0.5 (maximum mix at <code>p_res</code> = 0.5) to 1 (single use).</li>
<li>
<code>bal</code>: Balance Index (BAL), ranging from 0 (single use) to 1 (maximum balance), where balance is defined relative to the citywide residential proportion (i.e., the maximum occurs when <code>p_res</code> equals the citywide residential share).</li>
<li>
<code>hhi_adp</code>: adapted HHI, which adds directionality and takes values in [-1, 1], where negative values indicate non-residential dominance and positive values indicate residential dominance (0 indicates a 50/50 split).</li>
<li>
<code>bgbi</code>: Bidirectional Global-centered Balance Index (BGBI), which measures the deviation of the local residential share (<code>p_res</code>) from the citywide residential proportion, also in [-1, 1].</li>
</ul>
<div class="section level3">
<h3 id="choosing-a-backend-performance-1">Choosing a backend (performance)<a class="anchor" aria-label="anchor" href="#choosing-a-backend-performance-1"></a>
</h3>
<p>Like <code><a href="reference/hex_cnefe_counts.html">hex_cnefe_counts()</a></code>, <code><a href="reference/compute_lumi.html">compute_lumi()</a></code> supports a <code>backend</code> argument. Below is an example for Fortaleza (IBGE code 2304400) at H3 resolution 8:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pedreirajr/cnefetools" class="external-link">cnefetools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute land use mix indicators (recommended for large cities)</span></span>
<span><span class="va">lumi_for</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/compute_lumi.html">compute_lumi</a></span><span class="op">(</span>code_muni <span class="op">=</span> <span class="fl">2304400</span>, h3_resolution <span class="op">=</span> <span class="fl">8</span>, backend <span class="op">=</span> <span class="st">"duckdb"</span>, verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>You can visualize the spatial distribution of the BGBI indicator with <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">lumi_for</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">bgbi</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    fill <span class="op">=</span> <span class="st">"BGBI"</span>,</span>
<span>    title <span class="op">=</span> <span class="st">"Bidirectional Global-centered Balance Index (BGBI)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Fortaleza (IBGE 2304400), H3 resolution 8"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-10-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="dasymetric-interpolation-from-census-tracts-to-h3-with-tracts_to_h3">Dasymetric interpolation from census tracts to H3 with <code>tracts_to_h3()</code>
<a class="anchor" aria-label="anchor" href="#dasymetric-interpolation-from-census-tracts-to-h3-with-tracts_to_h3"></a>
</h2>
<p><code><a href="reference/tracts_to_h3.html">tracts_to_h3()</a></code> implements a dasymetric interpolation workflow that transfers census tract totals to address-level points (CNEFE), and then aggregates the allocated values to an H3 grid.</p>
<div class="section level3">
<h3 id="what-the-function-does">What the function does<a class="anchor" aria-label="anchor" href="#what-the-function-does"></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<strong>Prepare inputs in DuckDB</strong>
<ul>
<li>Downloads (once) and caches a UF-specific Parquet file with 2022 census tract geometries and tract-level aggregates.</li>
<li>Reads CNEFE points for the requested municipality (from the cached municipal ZIP).</li>
<li>Builds tract geometries (<code>MULTIPOLYGON</code>) and point geometries from coordinates.</li>
</ul>
</li>
<li>
<strong>Stage 1: census tracts to CNEFE points</strong>
<ul>
<li>Spatially assigns each CNEFE point to a census tract.</li>
<li>For each tract and dwelling type, computes how many eligible dwellings exist in the tract and allocates tract totals across points.</li>
</ul>
</li>
<li>
<strong>Stage 2: CNEFE points to H3</strong>
<ul>
<li>Assigns each point to an H3 cell at the chosen resolution and sums allocated values per cell.</li>
<li>Builds an H3 hexagon <code>sf</code> layer and joins the aggregated values.</li>
</ul>
</li>
</ol>
<p>The output is an <code>sf</code> object (CRS 4326) with one row per H3 hexagon, <code>id_hex</code>, and the interpolated variables you requested.</p>
</div>
<div class="section level3">
<h3 id="variables-available-for-interpolation">Variables available for interpolation<a class="anchor" aria-label="anchor" href="#variables-available-for-interpolation"></a>
</h3>
<p>At the moment, <code><a href="reference/tracts_to_h3.html">tracts_to_h3()</a></code> can interpolate the variables below (all sourced from tract-level aggregates), by choosing which ones to compute via the <code>vars</code> argument:</p>
<ul>
<li><p><code>n_inhab_p</code>: total population in <strong>private households</strong> (domicílios particulares);</p></li>
<li><p><code>n_inhab_c</code>: total population in <strong>collective households</strong> (domicílios coletivos);</p></li>
<li><p><code>n_resp</code>: number of household heads (<em>Pessoas responsáveis</em>);</p></li>
<li><p>Sex totals: <code>male</code> (total male population) and <code>female</code> (total female population);</p></li>
<li><p>Age groups : <code>age_0_4</code>, <code>age_5_9</code>, <code>age_10_14</code>, <code>age_15_19</code> - <code>age_20_24</code>, <code>age_25_29</code>, <code>age_30_39</code>, <code>age_40_49</code>, <code>age_50_59</code>, <code>age_60_69</code> and <code>age_70m</code> (70+);</p></li>
<li><p>Income: <code>avg_inc_resp</code>: average income of the responsible person (mean at tract level).</p></li>
</ul>
<div class="section level4">
<h4 id="allocation-rules-important">Allocation rules (important)<a class="anchor" aria-label="anchor" href="#allocation-rules-important"></a>
</h4>
<ul>
<li>For <strong>count-type totals</strong> (population by sex/age, <code>n_resp</code>, and the population totals):
<ul>
<li>values are allocated across <strong>private household points</strong> within each tract when private dwellings exist;</li>
<li>if a tract has <strong>no private dwellings</strong>, the value is allocated across <strong>collective household points</strong> (if any);</li>
<li>if a tract has <strong>no eligible dwellings</strong> (or the tract total is <code>NA</code>), that tract total is <strong>not allocated</strong>, and it is reported in the diagnostics.</li>
</ul>
</li>
<li>For <code>avg_inc_resp</code>:
<ul>
<li>the tract value is assigned directly to each eligible dwelling point (private, or collective only when there are no private dwellings in that tract);</li>
<li>when <code>avg_inc_resp</code> is <code>NA</code>, the function reports how many tracts had missing values.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="diagnostics-and-timing">Diagnostics and timing<a class="anchor" aria-label="anchor" href="#diagnostics-and-timing"></a>
</h3>
<p><code><a href="reference/tracts_to_h3.html">tracts_to_h3()</a></code> prints an execution timing summary (when <code>verbose = TRUE</code>) and may emit a warning with a diagnostic report. The diagnostics report includes, for each requested variable:</p>
<ul>
<li>unallocated tract totals (with the percentage relative to the tract total for that municipality);</li>
<li>tracts with <code>NA</code> totals;</li>
<li>tracts with no eligible dwellings (so nothing could be allocated);</li>
<li>unmatched CNEFE points (points that did not fall in any tract).</li>
</ul>
</div>
<div class="section level3">
<h3 id="example-recife-2611606">Example: Recife (2611606)<a class="anchor" aria-label="anchor" href="#example-recife-2611606"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pedreirajr/cnefetools" class="external-link">cnefetools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Interpolate to H3 for Recife at resolution 9</span></span>
<span><span class="co"># Example vars: private-household population and mean income of the responsible person</span></span>
<span><span class="va">rec_hex</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/tracts_to_h3.html">tracts_to_h3</a></span><span class="op">(</span></span>
<span>  code_muni <span class="op">=</span> <span class="fl">2611606</span>,</span>
<span>  h3_resolution <span class="op">=</span> <span class="fl">9</span>,</span>
<span>  vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n_inhab_p"</span>, <span class="st">"avg_inc_resp"</span><span class="op">)</span>,</span>
<span>  cache <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Map private-household population</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rec_hex</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">n_inhab_p</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Dasymetric interpolation to H3 using CNEFE (Recife)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Private-household population (n_inhab_p), H3 resolution 9"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Population"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-12-1.png" width="100%"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Map avg income of the household head</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rec_hex</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">avg_inc_resp</span><span class="op">)</span>, color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    title <span class="op">=</span> <span class="st">"Dasymetric interpolation to H3 using CNEFE (Recife)"</span>,</span>
<span>    subtitle <span class="op">=</span> <span class="st">"Average income of the responsible person (avg_inc_resp), H3 resolution 9"</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"Income"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-13-1.png" width="100%"></p>
</div>
</div>
<div class="section level2">
<h2 id="citation">Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<p>If you use <strong>{cnefetools}</strong> in your work, please cite the associated preprint:</p>
<blockquote>
<p>Pedreira Jr., J. U.; Louro, T. V.; Assis, L. B. M.; Brito, P. L. <em>Measuring land use mix with address-level census data</em> (2025). engrXiv. <a href="https://engrxiv.org/preprint/view/5975" class="external-link uri">https://engrxiv.org/preprint/view/5975</a></p>
</blockquote>
</div>
<div class="section level2">
<h2 id="roadmap">Roadmap<a class="anchor" aria-label="anchor" href="#roadmap"></a>
</h2>
<p>The current version focuses on efficient download, caching, and reading of municipality-level CNEFE files, plus scalable H3-based analytics (counts, land-use mix, and tract-to-hex dasymetric interpolation).</p>
<p>Planned next steps include:</p>
<ul>
<li>Expanding the set of tract-level variables available for dasymetric interpolation.</li>
<li>More diagnostics and summary helpers (for example, returning a diagnostics object as an attribute).</li>
<li>Support alternative aggregate data sources and target geographic output (other than H3), when available.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/pedreirajr/cnefetools/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/pedreirajr/cnefetools/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cnefetools</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jorge Ubirajara Pedreira Junior <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-8243-5395" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a>  </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jorge Ubirajara Pedreira Junior.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
