---
title: "Exploring CNEFE address data"
editor_options:
  markdown:
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

The 2022 Brazilian CNEFE (*Cadastro Nacional de Endereços para Fins
Estatísticos*) is an address-level dataset released by IBGE containing
over 100 million geocoded records across all Brazilian municipalities.
Each record carries the address type (`COD_ESPECIE`), geographic
coordinates, and a free-text description of the establishment
(`DSC_ESTABELECIMENTO`) for non-residential addresses.

`read_cnefe()` downloads and reads CNEFE data for any municipality,
returning either an Arrow table or an `sf` spatial object of point data.
This article walks through a practical example: filtering health
facilities and finding those that contain the term "hospital" in the
`DSC_ESTABELECIMENTO` column.

## Downloading CNEFE data

You can download CNEFE data for any Brazilian municipality with just a
single line of code. To avoid downloading the same file in all sections,
you can cache the municipality of interest by setting the `cache`
parameter to `TRUE`.

```{r}
library(cnefetools)
library(dplyr)

# Download CNEFE for Salvador (IBGE code 2927408)
ssa_cnefe <- read_cnefe(code_muni = 2927408, cache = TRUE)
```

The default output is an Arrow table, which is memory-efficient for
large municipalities. For example, Salvador has over 1.3 million
records.

## Exploring available columns

```{r}
names(ssa_cnefe)
```

Key columns for this example:

-   **`COD_ESPECIE`** — address type (1 = private household, 2 =
    collective household, 3 = agricultural, 4 = educational, 5 = health,
    6 = other, 7 = under construction, 8 = religious).
-   **`DSC_ESTABELECIMENTO`** — free-text name/description of the
    establishment (only filled for non-residential addresses).
-   **`LONGITUDE`** and **`LATITUDE`** — geographic coordinates.

A spreadsheet with the data dictionary (in Portuguese) can be accessed
with the function `cnefe_dictionary()`, which will open your system's
default spreadsheet viewer. To understand the whole methodology of the
CNEFE collection, you should also consult the PDF methodological
document with the `cnefe_doc()` function. Currently, only the CNEFE from
the 2022 Census is available in the package.

```{r}
## Opens the bundled Excel data dictionary:
cnefe_dictionary(year = 2022)

## Opens the bundled PDF methodological document:
cnefe_doc(year = 2022)
```

## Filtering for health establishments

We can keep only health establishments (`COD_ESPECIE == 5`) and convert
the file into a data frame:

```{r}
ssa_health <- ssa_cnefe |>
  filter(COD_ESPECIE == 5) |> 
  collect()
  
nrow(ssa_health)
```

## Searching for "hospital" in the description

We can use `grepl()` within `dplyr::filter()` to find records containing
specific terms:

```{r}
ssa_hospitals <- ssa_health |>
  filter(grepl("hospital", DSC_ESTABELECIMENTO, ignore.case = TRUE))

ssa_hospitals
```

## Mapping the results

To visualise the locations, we convert to an `sf` object and use
`mapview` for an interactive map:

```{r}
library(sf)
library(mapview)

ssa_hospitals_sf <- ssa_hospitals |>
  filter(!is.na(LONGITUDE), !is.na(LATITUDE)) |>
  st_as_sf(
    coords = c("LONGITUDE", "LATITUDE"),
    crs = 4674
  )

mapview(ssa_hospitals_sf, layer.name = "Health facilities with 'hospital' term in their description column in Salvador")
```

## Notes

Remember that it is also possible to read the file as a spatial `sf`
object by setting the `output` option to "sf" as follows:

```{r}
ssa_cnefe_sf <- read_cnefe(code_muni = 2927408, cache = TRUE, output = "sf")
```

Be careful, however, when plotting the full dataset, since large
municipalities may contain millions of points.
